#pieces needed to run the associator-related stuff
include "Geometry/CMSCommonData/data/cmsIdealGeometryXML.cff"
include "MagneticField/Engine/data/volumeBasedMagneticField.cfi"
include "Geometry/CaloEventSetup/data/CaloGeometry.cfi"
include "Geometry/CommonDetUnit/data/globalTrackingGeometry.cfi"
include "TrackPropagation/SteppingHelixPropagator/data/SteppingHelixPropagatorAny.cfi"
include "TrackingTools/TrackAssociator/data/DetIdAssociatorESProducer.cff" 

include "RecoMuon/MuonIsolationProducers/data/muIsoDepositCtfTk.cfi"
include "RecoMuon/MuonIsolationProducers/data/muIsoDepositCalByAssociatorTowers.cfi"
include "RecoMuon/MuonIsolationProducers/data/muIsoDepositCalByAssociatorHits.cfi"


#muIsoDeposit from tracks for trackerMuons; make distinct names for tracker and global muons
module muGlobalIsoDepositCtfTk 
       = muIsoDepositCtfTk from "RecoMuon/MuonIsolationProducers/data/muIsoDepositCtfTk.cfi"

module muParamGlobalIsoDepositGsTk 
       = muIsoDepositCtfTk from "RecoMuon/MuonIsolationProducers/data/muIsoDepositCtfTk.cfi"
replace muParamGlobalIsoDepositGsTk.InputType = "MuonCollection"
replace muParamGlobalIsoDepositGsTk.MuonTrackRefType = "track" 
replace muParamGlobalIsoDepositGsTk.inputMuonCollection = paramMuons:ParamGlobalMuons
replace muParamGlobalIsoDepositGsTk.ExtractorPSet.inputTrackCollection = gsWithMaterialTracks

module muTrackerIsoDepositCtfTk 
       = muIsoDepositCtfTk from "RecoMuon/MuonIsolationProducers/data/muIsoDepositCtfTk.cfi"
replace muTrackerIsoDepositCtfTk.InputType = "MuonCollection"
replace muTrackerIsoDepositCtfTk.MuonTrackRefType = "track"         
replace muTrackerIsoDepositCtfTk.inputMuonCollection = trackerMuons

include "RecoMuon/MuonIsolationProducers/data/caloExtractorByAssociatorBlocks.cff"
#muIsoDeposit maker for trackerMuons based on TrackAssociator using towers
module muGlobalIsoDepositCalByAssociatorTowers 
       = muIsoDepositCalByAssociatorTowers from "RecoMuon/MuonIsolationProducers/data/muIsoDepositCalByAssociatorTowers.cfi"
replace muGlobalIsoDepositCalByAssociatorTowers.InputType = "TrackCollection"
replace muGlobalIsoDepositCalByAssociatorTowers.MuonTrackRefType = "combinedMuon"       
replace muGlobalIsoDepositCalByAssociatorTowers.inputMuonCollection = globalMuons

module muTrackerIsoDepositCalByAssociatorTowers 
       = muIsoDepositCalByAssociatorTowers from "RecoMuon/MuonIsolationProducers/data/muIsoDepositCalByAssociatorTowers.cfi"
replace muTrackerIsoDepositCalByAssociatorTowers.InputType = "MuonCollection"
replace muTrackerIsoDepositCalByAssociatorTowers.MuonTrackRefType = "track"       
replace muTrackerIsoDepositCalByAssociatorTowers.inputMuonCollection = trackerMuons

#muIsoDeposit maker for globalMuons and trackerMuons based on TrackAssociator using rec-hits
module muGlobalIsoDepositCalByAssociatorHits 
       = muIsoDepositCalByAssociatorHits from "RecoMuon/MuonIsolationProducers/data/muIsoDepositCalByAssociatorHits.cfi"
replace muGlobalIsoDepositCalByAssociatorHits.InputType = "TrackCollection"
replace muGlobalIsoDepositCalByAssociatorHits.MuonTrackRefType = "combinedMuon"       
replace muGlobalIsoDepositCalByAssociatorHits.inputMuonCollection = globalMuons

module muTrackerIsoDepositCalByAssociatorHits 
       = muIsoDepositCalByAssociatorHits from "RecoMuon/MuonIsolationProducers/data/muIsoDepositCalByAssociatorHits.cfi"
replace muTrackerIsoDepositCalByAssociatorHits.InputType = "MuonCollection"
replace muTrackerIsoDepositCalByAssociatorHits.MuonTrackRefType = "track"       
replace muTrackerIsoDepositCalByAssociatorHits.inputMuonCollection = trackerMuons

include "RecoMuon/MuonIsolationProducers/data/jetExtractorBlock.cff"
#muIsoDeposit maker for trackerMuons based on TrackAssociator using towers
module muGlobalIsoDepositJets 
       = muIsoDepositJets from "RecoMuon/MuonIsolationProducers/data/muIsoDepositJets.cfi"
replace muGlobalIsoDepositJets.InputType = "TrackCollection"
replace muGlobalIsoDepositJets.MuonTrackRefType = "combinedMuon"       
replace muGlobalIsoDepositJets.inputMuonCollection = globalMuons

module muTrackerIsoDepositJets 
       = muIsoDepositJets from "RecoMuon/MuonIsolationProducers/data/muIsoDepositJets.cfi"
replace muTrackerIsoDepositJets.InputType = "MuonCollection"
replace muTrackerIsoDepositJets.MuonTrackRefType = "track"       
replace muTrackerIsoDepositJets.inputMuonCollection = trackerMuons

#Ecal-only muIsoDeposit using CaloExtractor for globalMuons
module muGlobalIsoDepositCalEcal = muIsoDepositCal from "RecoMuon/MuonIsolationProducers/data/muIsoDepositCal.cfi"
replace muGlobalIsoDepositCalEcal.ExtractorPSet.Weight_E = 1
replace muGlobalIsoDepositCalEcal.ExtractorPSet.Weight_H = 0


#the same but for FastSim muons
module muParamGlobalIsoDepositCalEcal = muIsoDepositCal from "RecoMuon/MuonIsolationProducers/data/muIsoDepositCal.cfi"
replace muParamGlobalIsoDepositCalEcal.ExtractorPSet.Weight_E = 1
replace muParamGlobalIsoDepositCalEcal.ExtractorPSet.Weight_H = 0
replace muParamGlobalIsoDepositCalEcal.InputType = "MuonCollection"
replace muParamGlobalIsoDepositCalEcal.MuonTrackRefType = "track"       
replace muParamGlobalIsoDepositCalEcal.inputMuonCollection = paramMuons:ParamGlobalMuons
replace muParamGlobalIsoDepositCalEcal.ExtractorPSet.CaloTowerCollectionLabel = towerMaker

#the same but for tracker muons
module muTrackerIsoDepositCalEcal = muIsoDepositCal from "RecoMuon/MuonIsolationProducers/data/muIsoDepositCal.cfi"
replace muTrackerIsoDepositCalEcal.ExtractorPSet.Weight_E = 1
replace muTrackerIsoDepositCalEcal.ExtractorPSet.Weight_H = 0
replace muTrackerIsoDepositCalEcal.InputType = "MuonCollection"
replace muTrackerIsoDepositCalEcal.MuonTrackRefType = "track"       
replace muTrackerIsoDepositCalEcal.inputMuonCollection = trackerMuons

#Hcal-only muIsoDeposit using CaloExtractor for globalMuons
module muGlobalIsoDepositCalHcal = muIsoDepositCal from "RecoMuon/MuonIsolationProducers/data/muIsoDepositCal.cfi"
replace muGlobalIsoDepositCalHcal.ExtractorPSet.Weight_E = 0
replace muGlobalIsoDepositCalHcal.ExtractorPSet.Weight_H = 1

#the same, but for FastSim muons
module muParamGlobalIsoDepositCalHcal = muIsoDepositCal from "RecoMuon/MuonIsolationProducers/data/muIsoDepositCal.cfi"
replace muParamGlobalIsoDepositCalHcal.ExtractorPSet.Weight_E = 0
replace muParamGlobalIsoDepositCalHcal.ExtractorPSet.Weight_H = 1
replace muParamGlobalIsoDepositCalHcal.InputType = "MuonCollection"
replace muParamGlobalIsoDepositCalHcal.MuonTrackRefType = "track"       
replace muParamGlobalIsoDepositCalHcal.inputMuonCollection = paramMuons:ParamGlobalMuons
replace muParamGlobalIsoDepositCalHcal.ExtractorPSet.CaloTowerCollectionLabel = towerMaker

#the same, but for tracker muons
module muTrackerIsoDepositCalHcal = muIsoDepositCal from "RecoMuon/MuonIsolationProducers/data/muIsoDepositCal.cfi"
replace muTrackerIsoDepositCalHcal.ExtractorPSet.Weight_E = 0
replace muTrackerIsoDepositCalHcal.ExtractorPSet.Weight_H = 1
replace muTrackerIsoDepositCalHcal.InputType = "MuonCollection"
replace muTrackerIsoDepositCalHcal.MuonTrackRefType = "track"       
replace muTrackerIsoDepositCalHcal.inputMuonCollection = trackerMuons


##########################################################################
# and now sequences of the above
##########################################################################

sequence muIsoDepositsAssoc_globalMuons = {
  muGlobalIsoDepositCalByAssociatorTowers & muGlobalIsoDepositCalByAssociatorHits
}
sequence muIsoDepositsAssoc_trackerMuons = {
  muTrackerIsoDepositCalByAssociatorTowers & muTrackerIsoDepositCalByAssociatorHits
}
#------------------------------

sequence muIsoDepositsCal_globalMuons = {
  muGlobalIsoDepositCalEcal & muGlobalIsoDepositCalHcal
}
sequence muIsoDepositsCal_ParamGlobalMuons = {
  muParamGlobalIsoDepositCalEcal & muParamGlobalIsoDepositCalHcal
}
sequence muIsoDepositsCal_trackerMuons = {
  muTrackerIsoDepositCalEcal & muTrackerIsoDepositCalHcal
}
#------------------------------

sequence muIsoDepositsJets_globalMuons = {
  muGlobalIsoDepositJets
}

sequence muIsoDepositsJets_trackerMuons = {
  muTrackerIsoDepositJets
}

#------------------------------

sequence muIsoDepositsTk_globalMuons = {
  muGlobalIsoDepositCtfTk
}
sequence muIsoDepositsTk_ParamGlobalMuons = {
  muParamGlobalIsoDepositGsTk
}
sequence muIsoDepositsTk_trackerMuons = {
  muTrackerIsoDepositCtfTk
}

#------------------------------
# "standard sequences"
sequence muIsoDeposits_globalMuons = {
  muIsoDepositsTk_globalMuons & muGlobalIsoDepositCalByAssociatorTowers & muIsoDepositsJets_globalMuons
}

sequence muIsoDeposits_ParamGlobalMuons = {
  muIsoDepositsTk_ParamGlobalMuons & muIsoDepositsCal_ParamGlobalMuons
}

sequence muIsoDeposits_trackerMuons = {
  muTrackerIsoDepositCtfTk & muTrackerIsoDepositCalByAssociatorTowers & muIsoDepositsJets_trackerMuons
}
